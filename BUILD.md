# Building ReaTC

## Quick Start

```bash
make              # build + verify (VERSION=DEV)
make build v=1.0.0
```

## Build System

The project uses a Python-based build with a `Makefile` wrapper.

### What the build does

1. **Version substitution** — replaces `{{VERSION}}` placeholders in all source files with the version passed via `--version` (default: `DEV`)
2. **Changelog injection** — replaces `{{CHANGELOG}}` in source files with the matching entry from `CHANGELOG.md`
3. **File copying** — copies `src/Scripts/ReaTC/` → `dist/Scripts/ReaTC/` and `src/Effects/ReaTC/` → `dist/Effects/ReaTC/`
4. **Metadata** — copies `LICENSE`, `README.md`, and `ABOUT.md` to `dist/`

`index.xml` is **not** generated by this script — it is published to the `reapack` branch by `reapack-index` when a release tag is pushed.

### Directory structure after build

```
dist/
├── LICENSE
├── README.md
├── Scripts/
│   └── ReaTC/
│       ├── reatc.lua
│       ├── reatc_core.lua
│       ├── reatc_outputs.lua
│       ├── reatc_ui.lua
│       ├── reatc_regions_to_ltc.lua
│       ├── reatc_artnet.py
│       ├── reatc_osc.py
│       └── reatc_ltcgen.py
└── Effects/
    └── ReaTC/
        └── reatc_tc.jsfx
```

## Available Commands

```bash
make                     # Build, verify, and build extension (default)
make build               # Build only (VERSION=DEV)
make build v=1.0.0       # Build with specific version
make verify              # Verify all dist/ files are present with correct version
make extension           # Build C++ extension (reaper_reatc)
make clean               # Remove dist/ and extension build
make watch               # Rebuild on changes (requires watchexec)
make help                # Show help
```

## C++ Extension

The C++ extension registers custom REAPER action IDs for ReaTC. It is built separately from the Lua/JSFX build:

```bash
make extension
```

This runs CMake against `src/extension/` and produces platform-specific binaries. The extension is included in releases via `@provides` platform entries in `reatc.lua`.

## Auto Rebuild on Changes

```bash
make watch
```

Requires `watchexec` — install dev tools first, see [DEVELOPMENT.md](DEVELOPMENT.md).

## Version Management

Version is **not** stored in a file — it is passed at build time:

```bash
make build v=1.0.0
```

All source files use `{{VERSION}}` as a placeholder. Never hardcode version strings in source files.

## Development Workflow

1. Edit source files in `src/`
2. `make` — builds and verifies `dist/`
3. Test by loading `dist/Scripts/ReaTC/reatc.lua` in REAPER
4. Commit `src/` changes (never commit `dist/`)

## Release Workflow

1. Add a `## [version] - date` entry to `CHANGELOG.md`
2. Commit
3. `git tag -a v1.0.0 -m "v1.0.0" && git push origin v1.0.0`

GitHub Actions (`release.yml`) then:
- Builds the project with the tag version
- Publishes `dist/` to the `reapack` branch via `reapack-index`
- Creates a GitHub Release

CI (`check.yml`) runs on every push to `main`/`dev`: build smoke test, artifact verification, unsubstituted-placeholder check, Lua syntax, Python syntax, pytest, and C++ extension build. CHANGELOG validation only happens in `release.yml` (on tag push).

## Troubleshooting

**Version not substituted in output:**
Check that the placeholder is exactly `{{VERSION}}` (not `{VERSION}` or `{{ VERSION }}`).

**Build fails — no source files found:**
Ensure `src/Scripts/ReaTC/` and `src/Effects/ReaTC/` exist and contain the expected files.

**`make` not found / resolves to wrong command (zsh):**
```bash
/usr/bin/make
```
