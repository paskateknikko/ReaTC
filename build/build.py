#!/usr/bin/env python3
"""
Build script for ReaTC.

Substitutes {{VERSION}} (and {{CHANGELOG}}) in source files and copies src/ → dist/.
Version is passed via --version flag (default: DEV).
index.xml is generated by reapack-index on the reapack branch — not by this script.
"""

import sys
import shutil
import re
from pathlib import Path

BUILD_DIR = Path(__file__).parent
REPO_ROOT = BUILD_DIR.parent
SRC_DIR = REPO_ROOT / "src"
DIST_DIR = REPO_ROOT / "dist"


def substitute_version(content, version):
    """Replace {{VERSION}} placeholder with actual version"""
    return content.replace("{{VERSION}}", version)


def read_changelog_for_version(version):
    """Extract changelog notes for a specific version from CHANGELOG.md.
    For DEV builds, returns 'Development build'."""
    if version == "DEV":
        return "Development build"
    changelog_file = REPO_ROOT / "CHANGELOG.md"
    if not changelog_file.exists():
        return f"Release {version}"
    with open(changelog_file, "r") as f:
        content = f.read()
    lines = content.splitlines()
    notes = []
    in_section = False
    for line in lines:
        if re.match(rf"^## \[{re.escape(version)}\]", line):
            in_section = True
            continue
        if in_section:
            if re.match(r"^## \[", line):
                break
            notes.append(line)
    notes_text = "\n".join(notes).strip()
    return notes_text if notes_text else f"Release {version}"


def build(version="DEV"):
    """Build and distribute files"""
    try:
        print(f"Building ReaTC v{version}...")
        print()

        # Verify source directory exists
        if not SRC_DIR.exists():
            raise FileNotFoundError(f"src/ directory not found at {SRC_DIR}")

        # Clean dist directory
        if DIST_DIR.exists():
            shutil.rmtree(DIST_DIR)
            print("  ✓ Cleaned previous dist/")
        DIST_DIR.mkdir(parents=True, exist_ok=True)

        # Create Scripts/ReaTC and Effects/ReaTC subdirectories in dist
        dist_scripts_dir = DIST_DIR / "Scripts" / "ReaTC"
        dist_effects_dir = DIST_DIR / "Effects" / "ReaTC"
        dist_scripts_dir.mkdir(parents=True, exist_ok=True)
        dist_effects_dir.mkdir(parents=True, exist_ok=True)

        changelog = read_changelog_for_version(version)

        # Process source files: substitute version and copy to dist
        src_dirs = [
            (SRC_DIR / "Scripts" / "ReaTC", dist_scripts_dir),
            (SRC_DIR / "Effects" / "ReaTC", dist_effects_dir),
        ]

        files_processed = 0
        for src_dir, dist_dir in src_dirs:
            if not src_dir.exists():
                continue
            for filepath in sorted(src_dir.iterdir()):
                if filepath.is_file():
                    with open(filepath, "r") as f:
                        content = f.read()
                    content = substitute_version(content, version)
                    # Join multi-line changelog with comment prefix matching file type
                    if filepath.suffix == '.jsfx':
                        changelog_commented = "\n// ".join(changelog.split("\n"))
                    else:
                        changelog_commented = "\n-- ".join(changelog.split("\n"))
                    content = content.replace("{{CHANGELOG}}", changelog_commented)
                    dist_file = dist_dir / filepath.name
                    with open(dist_file, "w") as f:
                        f.write(content)
                    print(f"  ✓ {filepath.name}")
                    files_processed += 1

        if files_processed == 0:
            raise ValueError("No source files found in src/")

        # Copy LICENSE, README.md, ABOUT.md to dist root
        for filename in ["LICENSE", "README.md", "ABOUT.md"]:
            src = REPO_ROOT / filename
            dst = DIST_DIR / filename
            if src.exists():
                shutil.copy2(src, dst)
                print(f"  ✓ {filename}")

        print()
        print(f"✓ Build complete: {DIST_DIR}")
        return 0

    except Exception as e:
        print(f"✗ Build failed: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('--version', default='DEV',
                        help='Version string (default: DEV)')
    args = parser.parse_args()
    sys.exit(build(version=args.version))
