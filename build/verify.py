#!/usr/bin/env python3
"""
Verification script for ReaTC build output.

Checks that all expected files exist in dist/ with correct version substitutions.
Version is passed via --version flag (default: DEV).
"""

import re
import sys
from pathlib import Path

BUILD_DIR = Path(__file__).parent
REPO_ROOT = BUILD_DIR.parent
DIST_DIR = REPO_ROOT / "dist"
PLATFORMS_ENV = BUILD_DIR / "platforms.env"


def parse_platforms_env():
    """Parse build/platforms.env and return a dict of key=value pairs."""
    config = {}
    if PLATFORMS_ENV.exists():
        for line in PLATFORMS_ENV.read_text().splitlines():
            line = line.strip()
            if line and not line.startswith("#"):
                m = re.match(r"^([A-Z_]+)=(.+)$", line)
                if m:
                    config[m.group(1)] = m.group(2)
    return config


def verify_badges(config):
    """Check that README.md badges match platforms.env values."""
    readme = REPO_ROOT / "README.md"
    if not readme.exists():
        # README is optional in dist; check repo root
        readme = DIST_DIR / "README.md"
    if not readme.exists():
        print("  ⚠ README.md not found, skipping badge check")
        return []

    content = readme.read_text()
    errors = []

    macos_target = config.get("MACOS_DEPLOYMENT_TARGET")
    win_version = config.get("WINDOWS_MIN_VERSION")

    if macos_target:
        # Badge format: macOS-10.15%2B  (URL-encoded '+')
        pattern = rf"macOS-{re.escape(macos_target)}%2B"
        if not re.search(pattern, content):
            errors.append(f"macOS badge missing or wrong (expected {macos_target})")

    if win_version:
        # Badge format: Windows-10%2B
        pattern = rf"Windows-{re.escape(win_version)}%2B"
        if not re.search(pattern, content):
            errors.append(f"Windows badge missing or wrong (expected {win_version})")

    return errors


def verify(version="DEV"):
    """Verify build output"""
    print(f"Verifying ReaTC v{version} build...")
    print()

    if not DIST_DIR.exists():
        print("✗ dist/ directory not found")
        return 1

    expected_files = {
        "LICENSE": None,
        "README.md": None,
        "ABOUT.md": None,
        # index.xml is generated by reapack-index on the reapack branch, not in dist/
        "Scripts/ReaTC/reatc.lua": version,
        "Scripts/ReaTC/reatc_core.lua": version,
        "Scripts/ReaTC/reatc_outputs.lua": version,
        "Scripts/ReaTC/reatc_ui.lua": version,
        "Scripts/ReaTC/reatc_regions_to_ltc.lua": version,
        "Scripts/ReaTC/reatc_artnet.py": version,
        "Scripts/ReaTC/reatc_osc.py": version,
        "Scripts/ReaTC/reatc_ltcgen.py": version,
        "Effects/ReaTC/reatc_tc.jsfx": version,
    }

    missing = []
    version_errors = []

    for filename, expected_version in expected_files.items():
        filepath = DIST_DIR / filename
        if not filepath.exists():
            missing.append(filename)
            print(f"  ✗ {filename} — missing")
        else:
            print(f"  ✓ {filename}")

            # Check version substitution if expected
            if expected_version:
                with open(filepath, "r", encoding="utf-8") as f:
                    content = f.read()
                if expected_version not in content:
                    version_errors.append(filename)
                    print(f"    ↳ WARNING: version {expected_version} not found in content")
                elif "{{VERSION}}" in content:
                    version_errors.append(filename)
                    print(f"    ↳ ERROR: {{{{VERSION}}}} placeholder not substituted")

    print()

    # Check README badges match platforms.env
    badge_errors = []
    config = parse_platforms_env()
    if config:
        print("Checking deployment target badges...")
        badge_errors = verify_badges(config)
        for err in badge_errors:
            print(f"  ✗ {err}")
        if not badge_errors:
            print("  ✓ Badges match platforms.env")
        print()

    if missing:
        print(f"✗ Missing {len(missing)} file(s)")
        return 1
    elif version_errors:
        print(f"✗ Version substitution errors in {len(version_errors)} file(s)")
        return 1
    elif badge_errors:
        print(f"✗ Badge mismatch: {len(badge_errors)} error(s)")
        return 1
    else:
        print(f"✓ All files present and version correctly substituted")
        return 0


if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('--version', default='DEV',
                        help='Version string (default: DEV)')
    args = parser.parse_args()
    sys.exit(verify(version=args.version))
